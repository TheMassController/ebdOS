include mk/basedirs.mk
include mk/compilers.mk
include mk/emptyvars.mk
include mk/predefined.mk
include mk/flags.mk

TARGET := jackoOS
TARGETBIN := jackoOS_stripped

KERNELAR := kernel.a
COREAR := core.a
USERAR := user.a

DEBUG_OBJECTS_DIR := $(OBJ_DIR)$(DEBUG_DIR)
RELEASE_OBJECTS_DIR := $(OBJ_DIR)$(RELEASE_DIR)
RELEASETARGET := $(RELEASE_DIR)$(TARGET)
DEBUGTARGET := $(DEBUG_DIR)$(TARGET)
RELEASETARGETBIN := $(RELEASE_DIR)$(TARGETBIN)
DEBUGTARGETBIN := $(DEBUG_DIR)$(TARGETBIN)

KERNELARDEBUG := $(DEBUG_DIR)$(KERNELAR)
KERNELARRELEASE := $(RELEASE_DIR)$(KERNELAR)
COREARDEBUG := $(DEBUG_DIR)$(COREAR)
COREARRELEASE := $(RELEASE_DIR)$(COREAR)

LINKRECEIPE = $(LD) $(LDFLAGS) -o $@ $^ $(LIB) 
OBJCOPYRECEIPE = $(OBJCOPY) $(OBJCPYFLAGS) -O binary $< $@ 
CCRECEIPE = $(CC) $(CFLAGS) -c $< -o $@
ASMRECEIPE = $(CC) $(ASMFLAGS) -c $< -o $@
ARRECEIPE = $(AR) $(ARFLAGS) $@ $^

OBJECTDIRS += $(RELEASE_DIR) $(DEBUG_DIR)

TOP :=./

DIRS := $(shell ls -d */)
DIRS := $(DIRS:=rules.mk)

.PHONY: echo all debug clean distclean

#all: echo
all: CFLAGS += -Os
all: pre-build
all: $(RELEASETARGETBIN)

debug: CFLAGS += -DDEBUG -g -Os
debug: LDFLAGS += -g
debug: ASMFLAGS += -g
debug: pre-build 
debug: $(DEBUGTARGET)

-include $(DIRS)

INC := $(addprefix -I,$(INCDIRS))
LIBDIR := $(addprefix -L,$(LIBDIRS))
LIB := $(addprefix -l,$(LIBS))

-include $(OFILES:%.o=%.d)
-include $(DOFILES:%.o=%.d)

$(COREARDEBUG) : $(COREDOFILES)
	$(ARRECEIPE)

$(COREARRELEASE) : $(COREROFILES)
	$(ARRECEIPE)

$(KERNELARDEBUG) : $(KERNELDOFILES)
	$(ARRECEIPE)

$(KERNELARRELEASE) : $(KERNELROFILES)
	$(ARRECEIPE)

$(RELEASETARGET) : $(OFILES) $(KERNELARRELEASE) $(COREARRELEASE) $(LINKER_SCRIPT)
	$(LD) $(LDFLAGS) -L$(RELEASE_DIR) -o $@ $(OFILES) $(KERNELARRELEASE) $(COREARRELEASE) $(LIB)

$(RELEASETARGETBIN) : $(RELEASETARGET)
	$(OBJCOPYRECEIPE)
	
$(DEBUGTARGET) : $(DOFILES) $(KERNELARDEBUG) $(COREARDEBUG) $(LINKER_SCRIPT)
	$(LD) $(LDFLAGS) -L$(DEBUG_DIR) -o $@ $(DOFILES) $(KERNELARDEBUG) $(COREARDEBUG) $(LIB) 

$(DEBUGTARGETBIN) : $(DEBUGTARGET)
	$(OBJCOPYRECEIPE)

echo:
	@echo "DIRS" $(DIRS)
	@echo "LIBDIR" $(LIBDIR)
	@echo "LIB" $(LIB)
	@echo "OFILES" $(OFILES) 
	@echo "DOFILES" $(DOFILES)
	@echo "INC" $(INC)
	@echo "OBJECTDIRS" $(OBJECTDIRS)

pre-build:
	@mkdir -p $(OBJECTDIRS)

clean: 
	@rm -f $(COREROFILES) $(COREDOFILES) $(KERNELROFILES) $(KERNELDOFILES) $(OFILES) $(DOFILES) $(COREARDEBUG) $(COREARRELEASE) $(KERNELARDEBUG) $(KERNELARRELEASE) $(RELEASETARGET) $(RELEASETARGETBIN) $(DEBUGTARGET) $(DEBUGTARGETBIN)

distclean: 
	@rm -rf $(OBJECTDIRS)
